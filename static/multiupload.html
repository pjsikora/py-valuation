<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Wiele obrazów — upload (galeria + aparat)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --border:#d0d7de; --bg:#f6f8fa; --accent:#0969da; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background:#fff; color:#24292f; }
    .wrap { max-width: 900px; margin: 0 auto; }
    h1 { margin: 0 0 16px; }
    .drop {
      border: 2px dashed var(--border); border-radius: 12px; padding: 28px; background: var(--bg);
      text-align: center; transition: .2s border-color, .2s background;
    }
    .drop.dragover { border-color: var(--accent); background: #eef6ff; }
    .drop input[type=file] { display: none; }
    .btn { background: var(--accent); color: #fff; border: 0; padding: 10px 14px; border-radius: 10px; cursor: pointer; display:inline-block; }
    .btn:focus { outline: 2px solid #111827; outline-offset: 2px; }
    .muted { color:#57606a; font-size: 14px; }
    .note { margin-top: 10px; }
    .grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 16px;
    }
    .card {
      border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #fff; display:flex; flex-direction:column;
    }
    .card img { width: 100%; height: 120px; object-fit: cover; display:block; background:#f3f4f6; }
    .card .meta { padding: 8px 10px; display:flex; justify-content: space-between; align-items: center; gap: 6px; }
    .x { border:0; background:#ef4444; color:#fff; border-radius: 8px; padding: 4px 8px; cursor:pointer; font-size:12px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-top: 16px; }
    pre { background:#0b1021; color:#e7e9ee; padding:12px; border-radius:10px; overflow:auto; }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Wyceń przedmiot</h1>

    <form id="form" action="/upload-images" method="post" enctype="multipart/form-data" novalidate>
      <div id="drop" class="drop" aria-label="Przeciągnij i upuść zdjęcia tutaj">
        <div role="group" aria-label="Dodawanie zdjęć">
          <label class="btn" aria-label="Wybierz zdjęcia z galerii">
            Wybierz z galerii
            <input id="file" type="file" name="files" accept="image/*" multiple />
          </label>

          <!-- NOWOŚĆ: przycisk otwierający aparat w Androidzie/iOS -->
          <label class="btn" style="margin-left:8px;" aria-label="Zrób zdjęcie aparatem">
            Zrób zdjęcie
            <!-- capture="environment" sugeruje tylną kamerę; użyj "user" dla przedniej -->
            <input id="camera" type="file" accept="image/*" capture="environment">
          </label>
        </div>

        <div class="note muted">
          Możesz dodać wiele zdjęć z galerii lub zrobić kolejne fotografie aparatem.
          Na niektórych urządzeniach pojawi się wybór: Aparat lub Pliki.
        </div>
      </div>

      <div id="grid" class="grid" aria-live="polite"></div>

      <div class="row">
        <button class="btn" type="submit">Wyślij</button>
        <span id="status" class="muted" role="status" aria-live="polite"></span>
      </div>
    </form>

    <h3>Odpowiedź serwera</h3>
    <div id="out">—</div>
  </div>

  <script>
    const input  = document.getElementById('file');
    const camera = document.getElementById('camera');
    const drop   = document.getElementById('drop');
    const grid   = document.getElementById('grid');
    const form   = document.getElementById('form');
    const out    = document.getElementById('out');
    const status = document.getElementById('status');

    const MAX_FILES = 10;
    const MAX_SIZE  = 10 * 1024 * 1024; // 10 MB

    /** aktualny zestaw wybranych plików (możliwość usuwania przed wysłaniem) */
    let files = [];

    function renderGrid() {
      grid.innerHTML = '';
      files.forEach((f, idx) => {
        const url = URL.createObjectURL(f);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${url}" alt="${f.name}" />
          <div class="meta">
            <small class="muted" title="${escapeHtml(f.name)}">${truncate(f.name, 18)}</small>
            <button class="x" data-idx="${idx}" type="button" aria-label="Usuń ${escapeHtml(f.name)}">Usuń</button>
          </div>
        `;
        grid.appendChild(card);
        // zwolnij URL po załadowaniu miniatury
        card.querySelector('img').addEventListener('load', () => URL.revokeObjectURL(url));
      });

      grid.querySelectorAll('.x').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.idx);
          files.splice(i, 1);
          renderGrid();
          updateStatus();
        });
      });
    }

    function truncate(s, n) {
      return s.length > n ? s.slice(0, n - 1) + '…' : s;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    function addFiles(list) {
      const incoming = Array.from(list);
      for (const f of incoming) {
        if (!f.type.startsWith('image/')) continue;
        if (f.size > MAX_SIZE) {
          alert(`Plik "${f.name}" przekracza limit 10 MB.`);
          continue;
        }
        if (files.length >= MAX_FILES) {
          alert(`Limit ${MAX_FILES} plików osiągnięty.`);
          break;
        }
        files.push(f);
      }
      renderGrid();
      updateStatus();
    }

    function updateStatus() {
      status.textContent = files.length ? `${files.length} plik(i)` : '';
    }

    // Input z galerii (pozwala na multiple)
    input.addEventListener('change', (e) => addFiles(e.target.files));

    // Input z aparatu — zwykle zwraca 1 zdjęcie; czyścimy value, by każde kolejne wywołało 'change'
    camera.addEventListener('change', (e) => {
      if (e.target.files && e.target.files.length) {
        addFiles(e.target.files);
        e.target.value = '';
      }
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(ev => {
      drop.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); });
    });
    ['dragleave','drop'].forEach(ev => {
      drop.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); });
    });
    drop.addEventListener('drop', (e) => addFiles(e.dataTransfer.files));

    // Submit via fetch — wyślij wszystkie aktualne pliki w FormData pod key "files"
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!files.length) { alert('Dodaj co najmniej jeden obraz.'); return; }

      status.textContent = 'Wysyłanie…';

      const fd = new FormData();
      files.forEach(f => fd.append('files', f, f.name));

      try {
        const res = await fetch(form.action, { method: 'POST', body: fd });
        const json = await res.json().catch(() => ({}));
        out.innerHTML = json?.response ?? '<em>Brak treści w odpowiedzi.</em>';
        status.textContent = res.ok ? 'Gotowe ✅' : 'Błąd ❌';
      } catch (err) {
        console.error(err);
        out.innerHTML = '<em>Nie udało się wysłać plików (sprawdź sieć/endpoint).</em>';
        status.textContent = 'Błąd ❌';
      }
    });

    // Drobna pomoc dla starszych przeglądarek: logujemy, jeśli capture może być zignorowane
    (function featureHint(){
      const ua = navigator.userAgent.toLowerCase();
      // iOS Safari potrafi zignorować capture — to ok, po prostu pokaże wybór
      if (/iphone|ipad|ipod/.test(ua)) {
        console.log('Uwaga: iOS może zignorować capture="environment" i pokaże wybór źródła.');
      }
    })();
  </script>
</body>
</html>
